<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>@{{ user.username }} ‚Äî Profile ‚Äî Muniverse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/static/img/favicon.png" type="image/png">
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet" />
</head>
<body>
  <header class="topbar">
    <a class="logo" href="{{ url_for('feed') }}">
      <img class="logo-image" src="{{ url_for('static', filename='img/favicon.png') }}" alt="Muniverse Logo">
      <span>Muniverse</span>
    </a>

    <!-- hamburger -->
    <input type="checkbox" id="menu-toggle" class="menu-toggle" aria-label="Toggle navigation">
    <label for="menu-toggle" class="hamburger">
      <span class="bar top-bar"></span>
      <span class="bar middle-bar"></span>
      <span class="bar bottom-bar"></span>
    </label>

    <nav class="nav">
      <a href="{{ url_for('feed') }}">Home</a>
      <a href="{{ url_for('explore') }}">Explore</a>
      <a href="{{ url_for('forums') }}">Forums</a>
      <a href="{{ url_for('conferences') }}">Conferences</a>
      <a href="{{ url_for('about') }}">About</a>

      {% if current_user %}
        <a href="{{ url_for('profile', username=current_user.username) }}" class="avatar-link" title="@{{ current_user.username }}">
          <img class="avatar-circle" src="{{ url_for('static', filename=current_user.profile_pic) }}" alt="{{ current_user.username }}">
        </a>
        <a class="btn-ghost" href="{{ url_for('logout') }}">Sign out</a>
      {% else %}
        <a class="btn" href="{{ url_for('login') }}">Sign in</a>
        <a class="btn btn-primary" href="{{ url_for('signup') }}">Create profile</a>
      {% endif %}
    </nav>
  </header>

  <main class="container">
    <section class="profile card">
      <div class="p-header">
        <img class="avatar-img" src="{{ url_for('static', filename=user.profile_pic) }}" alt="{{ user.username }}" />
        <div class="p-meta">
          <h1 class="page-title">@{{ user.username }}</h1>
          <p class="muted">{{ user.name }} ‚Ä¢ {{ user.school }}</p>
          <p class="desc">{{ user.bio }}</p>

          <div class="meta" style="display:flex; gap:14px; margin:8px 0;">
            <span><b>{{ (user.followers|length) if user.followers else 0 }}</b> Followers</span>
            <span><b>{{ (user.following|length) if user.following else 0 }}</b> Following</span>
          </div>

          {% if current_user %}
            {% if current_user.username == user.username %}
              <div class="actions">
                <a class="btn" href="{{ url_for('addconference') }}">Make a Conference</a>
                <a class="btn btn-primary" href="{{ url_for('addpost') }}">Add Post</a>
                <a class="btn btn-secondary" href="{{ url_for('settings_profile') }}">Edit Profile</a>
              </div>
            {% else %}
              <form id="followForm" class="actions" method="post" action="{{ url_for('follow', username=user.username) }}">
                <button id="followBtn" class="btn btn-primary" type="submit">
                  {% if current_user.username in (user.followers or []) %}Following{% else %}+ Follow{% endif %}
                </button>
              </form>
            {% endif %}
          {% endif %}

          {% if user.attendingConferences and user.attendingConferences|length > 0 %}
            <div class="tags" style="margin-top:8px;">
              {% for cid in user.attendingConferences %}
                <a class="tag" href="{{ url_for('conference', conf_id=cid) }}">{{ cid }}</a>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
    </section>

    <section class="container">
      <h3 class="section-title">Posts</h3>
      {% if posts|length == 0 %}
        <div class="empty card">
          <p>No posts by @{{ user.username }} yet.</p>
        </div>
      {% else %}
        <div class="grid">
          {% for post in posts %}
            <div class="card hoverable">
              <a href="{{ url_for('post', post_id=post.id) }}">
                <img class="cover" src="{{ url_for('static', filename=post.image) }}" alt="Post image" loading="lazy" />
              </a>
              <div class="pad-sm">
                <p class="caption clamp-2">{{ post.caption }}</p>
                <div class="meta">
                  <span>‚ù§Ô∏è {{ post.likes }}</span>
                  <span>üí¨ {{ post.comments|length }}</span>
                </div>

                {% if current_user and current_user.username == user.username %}
                  <div class="actions" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
                    <a class="btn" href="{{ url_for('post_edit', post_id=post.id) }}">Edit</a>
                    <form method="POST" action="{{ url_for('post_delete', post_id=post.id) }}" onsubmit="return confirm('Delete this post? This cannot be undone.');">
                      <button class="btn btn-ghost" type="submit">Delete</button>
                    </form>
                  </div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </section>
  </main>

  {% if current_user and current_user.username != user.username %}
  <script>
    // AJAX follow/unfollow (progressive enhancement)
    const form = document.getElementById('followForm');
    const btn  = document.getElementById('followBtn');
    if (form && btn) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        btn.disabled = true;
        try {
          const res = await fetch(form.action, { method: 'POST' });
          const data = await res.json();
          if (data.ok) {
            btn.textContent = (data.action === 'followed') ? 'Following' : '+ Follow';
            const followerCount = document.querySelector('.meta b');
            if (followerCount) followerCount.textContent = data.followers;
          }
        } catch (err) { console.error(err); }
        finally { btn.disabled = false; }
      });
    }
  </script>
  {% endif %}
</body>
</html>

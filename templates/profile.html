<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>@{{ user.username }} ‚Äî Profile ‚Äî Muniverse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet" />
</head>
<body>
  <header class="topbar">
    <a class="logo" href="{{ url_for('onboarding') }}">üåç <span>Muniverse</span></a>
    <nav class="nav">
      <a href="{{ url_for('feed') }}">Home</a>
      <a href="{{ url_for('explore') }}">Explore</a>
      <a href="{{ url_for('conferences') }}">Conferences</a>
      <a href="{{ url_for('about') }}">About</a>

      {% if current_user %}
        <a href="{{ url_for('profile', username=current_user.username) }}" class="avatar-link" title="@{{ current_user.username }}">
          <img class="avatar-circle" src="{{ url_for('static', filename=current_user.profile_pic) }}" alt="{{ current_user.username }}">
        </a>
        <a class="btn-ghost" href="{{ url_for('logout') }}">Sign out</a>
      {% else %}
        <a class="btn" href="{{ url_for('login') }}">Sign in</a>
        <a class="btn btn-primary" href="{{ url_for('signup') }}">Create profile</a>
      {% endif %}
    </nav>
  </header>

  <main class="container">
    <section class="profile card">
      <div class="p-header">
        <img class="avatar-img" src="{{ url_for('static', filename=user.profile_pic) }}" alt="{{ user.username }}" />
        <div class="p-meta">
          <h1 class="page-title">@{{ user.username }}</h1>
          <p class="muted">{{ user.name }} ‚Ä¢ {{ user.school }}</p>
          <p class="desc">{{ user.bio }}</p>

          <div class="meta" style="display:flex; gap:14px; margin:8px 0;">
            <span><b>{{ (user.followers|length) if user.followers else 0 }}</b> Followers</span>
            <span><b>{{ (user.following|length) if user.following else 0 }}</b> Following</span>
          </div>

          {% if current_user %}
            {% if current_user.username == user.username %}
              <div class="actions">
                <a class="btn" href="{{ url_for('addconference') }}">Make a Conference</a>
                <a class="btn btn-primary" href="{{ url_for('addpost') }}">Add Post</a>
              </div>
            {% else %}
              <form id="followForm" class="actions" method="post" action="{{ url_for('follow', username=user.username) }}">
                <button id="followBtn" class="btn btn-primary" type="submit">
                  {% if current_user.username in (user.followers or []) %}Following{% else %}+ Follow{% endif %}
                </button>
              </form>
            {% endif %}
          {% endif %}

          {% if user.attendingConferences and user.attendingConferences|length > 0 %}
            <div class="tags" style="margin-top:8px;">
              {% for cid in user.attendingConferences %}
                <a class="tag" href="{{ url_for('conference', conf_id=cid) }}">{{ cid }}</a>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
    </section>

    <section class="container">
      <h3 class="section-title">Posts</h3>
      {% if posts|length == 0 %}
        <div class="empty card">
          <p>No posts by @{{ user.username }} yet.</p>
        </div>
      {% else %}
        <div class="grid">
          {% for post in posts %}
            <a class="card hoverable" href="{{ url_for('post', post_id=post.id) }}">
              <img class="cover" src="{{ url_for('static', filename=post.image) }}" alt="Post image" loading="lazy" />
              <div class="pad-sm">
                <p class="caption clamp-2">{{ post.caption }}</p>
                <div class="meta">
                  <span>‚ù§Ô∏è {{ post.likes }}</span>
                  <span>üí¨ {{ post.comments|length }}</span>
                </div>
              </div>
            </a>
          {% endfor %}
        </div>
      {% endif %}
    </section>
  </main>

  {% if current_user and current_user.username != user.username %}
  <script>
    // Progressive enhancement: AJAX follow/unfollow (optional; form POST still works)
    const form = document.getElementById('followForm');
    const btn  = document.getElementById('followBtn');
    if (form && btn) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        btn.disabled = true;
        try {
          const res = await fetch(form.action, { method: 'POST' });
          const data = await res.json();
          if (data.ok) {
            btn.textContent = (data.action === 'followed') ? 'Following' : '+ Follow';
            // Optionally update counts in DOM:
            // find the first <b> (followers) and update textContent = data.followers
            const b = document.querySelector('.meta b');
            if (b) b.textContent = data.followers;
          }
        } catch (err) { console.error(err); }
        finally { btn.disabled = false; }
      });
    }
  </script>
  {% endif %}
</body>
</html>

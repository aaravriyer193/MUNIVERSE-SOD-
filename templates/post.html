<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Post #{{ post.id }} ‚Äî Muniverse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/static/img/favicon.png" type="image/png">
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet" />
</head>
<body>
  <header class="topbar">
    <a class="logo" href="{{ url_for('onboarding') }}">
    <img class="logo-image" src="{{ url_for('static', filename='img/favicon.png') }}" alt="Muniverse Logo">
    <span>Muniverse</span>
    </a>
        <nav class="nav">
      <a class="active" href="{{ url_for('feed') }}">Back to Feed</a>
    </nav>
  </header>

  <main class="container">
    <article class="card">
      <div class="hero">
        <img src="{{ url_for('static', filename=post.image) }}" alt="Post" />
      </div>

      <div class="pad">
        <header class="post-head">
          <div class="avatar-letter" data-letter="{{ post.username[0]|upper }}"></div>
          <a class="username" href="{{ url_for('profile', username=post.username) }}">@{{ post.username }}</a>
        </header>

        <div class="meta" style="margin:8px 0;">
          <button class="like-btn" data-post="{{ post.id }}">
            {% if current_user and current_user.username in (post.liked_by or []) %}
              ‚ù§Ô∏è
            {% else %}
              ü§ç
            {% endif %}
          </button>
          <span class="like-count" data-post="{{ post.id }}">{{ post.likes or 0 }}</span>
        </div>

        <p class="caption">{{ post.caption }}</p>

        <div class="meta">
          <span>üí¨ <span id="cCount">{{ (post.comments|length) if post.comments else 0 }}</span> comments</span>
        </div>

        {% if post.comments and post.comments|length > 0 %}
          <hr />
        {% endif %}

        <ul class="comments" id="commentList">
          {% for c in post.comments or [] %}
            <li>
              <strong>@{{ c.username }}</strong>
              <small class="muted">{{ c.ts }}</small>
              <div>{{ c.text }}</div>
            </li>
          {% endfor %}
        </ul>

        {% if current_user %}
          <form id="commentForm" class="row" action="{{ url_for('comment_post', post_id=post.id) }}" method="POST">
            <input name="text" id="cText" placeholder="Write a comment‚Ä¶" maxlength="1000" required />
            <button class="btn btn-primary" type="submit">Post</button>
          </form>
        {% else %}
          <p class="muted">Sign in to comment.</p>
        {% endif %}
      </div>
    </article>
  </main>

  <script>
  (function(){
    // Like
    document.querySelectorAll('.like-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        const id = btn.dataset.post;
        const res = await fetch(`/post/${id}/like`, { method: 'POST' });
        const data = await res.json();
        if (data.ok) {
          document.querySelector(`.like-count[data-post="${id}"]`).textContent = data.likes;
          btn.textContent = data.liked ? '‚ù§Ô∏è' : 'ü§ç';
        } else if (data.error === 'auth') {
          location.href = '/login?next=' + encodeURIComponent(location.pathname);
        }
      });
    });

    // Comment
    const form = document.getElementById('commentForm');
    if (!form) return;
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const input = document.getElementById('cText');
      const text = input.value.trim();
      if (!text) return;

      const res = await fetch(form.action, {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded'},
        body: new URLSearchParams({ text })
      });
      const data = await res.json();
      if (data.ok) {
        const li = document.createElement('li');
        li.innerHTML = `<strong>@${data.comment.username}</strong>
                        <small class="muted">${data.comment.ts}</small>
                        <div></div>`;
        li.querySelector('div').textContent = data.comment.text;
        document.getElementById('commentList').appendChild(li);

        input.value = '';
        const cCount = document.getElementById('cCount');
        if (cCount) cCount.textContent = data.count;
      } else if (data.error === 'auth') {
        location.href = '/login?next=' + encodeURIComponent(location.pathname);
      }
    });
  })();
  </script>
</body>
</html>

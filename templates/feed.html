<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Feed ‚Äî Muniverse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/static/img/favicon.png" type="image/png">
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet" />
</head>
<body>
  <header class="topbar">
    <a class="logo" href="{{ url_for('onboarding') }}">
    <img class="logo-image" src="{{ url_for('static', filename='img/favicon.png') }}" alt="Muniverse Logo">
    <span>Muniverse</span>
    </a>    
    <nav class="nav">
      <a href="{{ url_for('feed') }}">Home</a>
      <a href="{{ url_for('explore') }}">Explore</a>
      <a href="{{ url_for('forums') }}">Forums</a>
      <a href="{{ url_for('conferences') }}">Conferences</a>
      <a href="{{ url_for('about') }}">About</a>

      {% if current_user %}
        <a href="{{ url_for('profile', username=current_user.username) }}" class="avatar-link" title="@{{ current_user.username }}">
          <img class="avatar-circle" src="{{ url_for('static', filename=current_user.profile_pic) }}" alt="{{ current_user.username }}">
        </a>
        <a class="btn-ghost" href="{{ url_for('logout') }}">Sign out</a>
      {% else %}
        <a class="btn" href="{{ url_for('login') }}">Sign in</a>
        <a class="btn btn-primary" href="{{ url_for('signup') }}">Create profile</a>
      {% endif %}
    </nav>
  </header>

  <main class="container">
    {% if posts|length == 0 %}
      <div class="empty card">
        <h3>No posts yet</h3>
        <p>Be the first to share an update with the community.</p>
        {% if current_user %}
          <a class="btn btn-primary" href="{{ url_for('addpost') }}">Create a Post</a>
        {% else %}
          <a class="btn btn-primary" href="{{ url_for('login') }}">Sign in to post</a>
        {% endif %}
      </div>
    {% else %}
      <div class="feed-list">
        {% for post in posts %}
          <article class="post card">
            <header class="post-head">
              <div class="avatar-letter" data-letter="{{ post.username[0]|upper }}"></div>
              <a class="username" href="{{ url_for('profile', username=post.username) }}">@{{ post.username }}</a>
            </header>

            <div class="post-media">
              <img src="{{ url_for('static', filename=post.image) }}" alt="Post image by @{{ post.username }}" loading="lazy" />
            </div>

            <div class="post-body">
              <p class="caption">{{ post.caption }}</p>
              <div class="meta">
                <button class="like-btn" data-post="{{ post.id }}">
                  {% if current_user and current_user.username in (post.liked_by or []) %}
                    ‚ù§Ô∏è
                  {% else %}
                    ü§ç
                  {% endif %}
                </button>
                <span class="like-count" data-post="{{ post.id }}">{{ post.likes or 0 }}</span>
                <a href="{{ url_for('post', post_id=post.id) }}">üí¨ {{ (post.comments|length) if post.comments else 0 }} comments</a>
              </div>
            </div>
          </article>
        {% endfor %}
      </div>
    {% endif %}
  </main>

  <script>
  document.querySelectorAll('.like-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const id = btn.dataset.post;
      try {
        const res = await fetch(`/post/${id}/like`, { method: 'POST' });
        const data = await res.json();
        if (data.ok) {
          const countEl = document.querySelector(`.like-count[data-post="${id}"]`);
          if (countEl) countEl.textContent = data.likes;
          btn.textContent = data.liked ? '‚ù§Ô∏è' : 'ü§ç';
        } else if (data.error === 'auth') {
          location.href = '/login?next=' + encodeURIComponent(location.pathname);
        }
      } catch (err) {
        console.error(err);
      }
    });
  });
  </script>
</body>
</html>
